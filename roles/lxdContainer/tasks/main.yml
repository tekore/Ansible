---
- name: Check if LXD is installed (Fails if Lxd isn't)
  command: lxd version

- name: Create temporary directory for cloud-init
  tempfile:
    state: directory
    suffix: cloudinit
  register: cloudinit_temp_dir

- name: Generate cloud-init configuration from template
  template:
    src: cloud-init-user-data
    dest: "{{ cloudinit_temp_dir.path }}/user-data.yml"
    mode: '0644'
  register: cloud_init_file

- name: Show cloud-init config
  debug:
    var: cloud_init_content.stdout_lines
  when: debug_mode | default(false)

- name: Launch LXD container
  command: >
    lxc launch ubuntu:{{ ubuntu_version }} {{ container_name }}
    --config limits.memory={{ container_memory }}
    --config boot.autostart=true
  register: lxc_launch
  changed_when: "'Creating' in lxc_launch.stdout"

- name: Wait for container to be ready
  pause:
    seconds: 30

- name: Wait for cloud-init status
  command: lxc exec {{ container_name }} -- cloud-init status --wait
  register: cloud_init_wait
  failed_when: false
  changed_when: false

- name: Apply cloud-init configuration
  shell: |
    cat {{ cloud_init_file.dest }} | lxc exec {{ container_name }} -- tee /var/lib/cloud/seed/nocloud-net/user-data
  register: apply_config
  changed_when: true

- name: Clean cloud-init
  command: lxc exec {{ container_name }} -- cloud-init clean
  changed_when: true

- name: Restart container
  command: lxc restart {{ container_name }}
  changed_when: true

- name: Wait for container restart
  pause:
    seconds: 30

- name: Wait for cloud-init to complete
  command: lxc exec {{ container_name }} -- cloud-init status --wait
  register: cloud_init_complete
  changed_when: false

- name: Cleanup temporary directory
  file:
    path: "{{ cloudinit_temp_dir.path }}"
    state: absent
  when: cloudinit_temp_dir is defined