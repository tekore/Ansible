#cloud-config
write_files:
  - path: /tmp/runner_secrets.yml
    content: |
        ---
        # GitHub Runner Secrets
        github_repo_url: {{ github_repo_url }}
        github_runner_name: {{ github_runner_name }}
        github_pat: {{ github_pat }}
    owner: 'root:root'
    permissions: '0644'

ssh_pwauth: true
disable_root: false

chpasswd:
  list: |
    {{ runner_user }}:{{ runner_password }}
  expire: false

users:
  - name: "{{ runner_user }}"
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    lock_passwd: false

runcmd:
  - sleep 10
  - apt-get update
  - apt-get upgrade -y
  - apt-get install -y ansible openssh-server
  - ansible-pull -U {{ ansible_repo_url }} -i localhost --purge {{ ansible_repo_playbook }} --extra-vars "@/tmp/runner_secrets.yml"