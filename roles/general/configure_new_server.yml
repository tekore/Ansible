---
- name: Configure Server
  connection: local
  become: true
  become_user: root
  hosts: localhost
  tasks:
    - name: Create tekore user with specified groups
      ansible.builtin.user:
        name: tekore
        groups: adm,sudo,lxd,admin
        shell: /bin/bash
        create_home: yes

    - name: Copy ubuntu user files to tekore home
      ansible.builtin.copy:
        src: /home/ubuntu/{{ item }}
        dest: /home/tekore/{{ item }}
        owner: tekore
        group: tekore
        remote_src: yes
      loop:
        - .bashrc
        - .profile
        - .ssh

    - name: Set correct permissions on .ssh directory and files
      ansible.builtin.file:
        path: /home/tekore/.ssh/{{ item.path }}
        state: "{{ item.state | default(omit) }}"
        owner: tekore
        group: tekore
        mode: "{{ item.mode }}"
      loop:
        - { path: '', state: 'directory', mode: '0700' }
        - { path: 'authorized_keys', mode: '0600' }

    - name: Delete ubuntu user and home directory
      ansible.builtin.user:
        name: ubuntu
        state: absent
        remove: yes

    - name: Update all packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist

    - name: Install packages
      apt:
        pkg:
          - ufw
          - vim
          - lm-sensors
          - htop
          - fail2ban
        state: latest
        update_cache: true
    
    - name: Check UFW is disabled
      ufw:
        state: disabled

    - name: Ensure new SSH port is configured in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port\s+22'
        line: 'Port 2022'
        validate: 'sshd -t -f %s'
    
    - name: Restart the SSH service to apply changes
      ansible.builtin.service:
        name: ssh
        state: restarted

    - name: Copy fail2ban config and set permissions
      ansible.builtin.copy:
        src: ./fail2ban.conf
        dest: "/etc/fail2ban/jail.d/defaults-ubuntu.conf"
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start Fail2Ban
      ansible.builtin.systemd:
        name: fail2ban.service
        state: started
        enabled: yes
